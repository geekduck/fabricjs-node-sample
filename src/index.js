var fs = require('fs'),
    _ = require('underscore'),
    fabric = require('fabric').fabric,
    width = 975,
    height = 500;

var canvas = fabric.createCanvasForNode(width, height);
var font;
//font = new canvas.Font('cFont', '/System/Library/Fonts/ヒラギノ角ゴシック\ W3.ttc');
font = new canvas.Font('cFont', '/usr/share/fonts/ipa-gothic/ipag.ttf');
canvas.contextContainer.addFont(font); // when using createPNGStream or createJPEGStream
canvas.contextTop.addFont(font); // when using toDataURL or toDataURLWithMultiplier

var json = {
    "objects": [{
        "type": "Rect",
        "originX": "center",
        "originY": "center",
        "left": 123.63,
        "top": 122.63,
        "width": 207,
        "height": 207,
        "fill": "#fff",
        "stroke": "#000",
        "strokeWidth": 3,
        "strokeDashArray": null,
        "strokeLineCap": "butt",
        "strokeLineJoin": "miter",
        "strokeMiterLimit": 10,
        "scaleX": 1.19,
        "scaleY": 1.19,
        "angle": 0,
        "flipX": false,
        "flipY": false,
        "opacity": 1,
        "shadow": null,
        "visible": true,
        "clipTo": null,
        "backgroundColor": "",
        "rx": 0,
        "ry": 0,
        "x": 0,
        "y": 0
    }, {
        "type": "path",
        "originX": "center",
        "originY": "center",
        "left": 122.75,
        "top": 127.75,
        "width": 260,
        "height": 286,
        "fill": null,
        "stroke": "rgb(0, 0, 0)",
        "strokeWidth": 3,
        "strokeLineCap": "round",
        "strokeLineJoin": "round",
        "strokeMiterLimit": 10,
        "scaleX": 1,
        "scaleY": 1,
        "angle": 0,
        "flipX": false,
        "flipY": false,
        "opacity": 1,
        "shadow": null,
        "visible": true,
        "clipTo": null,
        "backgroundColor": "",
        "path": [
            ["M", 21.5, 15.5],
            ["Q", 21.5, 15.5, 22, 15.5],
            ["Q", 22.5, 15.5, 22.25, 16.5],
            ["Q", 22, 17.5, 21, 19],
            ["Q", 20, 20.5, 19.5, 22.5],
            ["Q", 19, 24.5, 17.5, 27],
            ["Q", 16, 29.5, 13, 36],
            ["Q", 10, 42.5, 8.5, 45.5],
            ["Q", 7, 48.5, 6, 50.5],
            ["Q", 5, 52.5, 4, 54.5],
            ["Q", 3, 56.5, 2.5, 58],
            ["Q", 2, 59.5, 2, 60],
            ["Q", 2, 60.5, 1, 61.5],
            ["Q", 0, 62.5, 0, 63],
            ["Q", 0, 63.5, 4.5, 62],
            ["Q", 9, 60.5, 14.5, 57],
            ["Q", 20, 53.5, 26.5, 49],
            ["Q", 33, 44.5, 43.5, 37.5],
            ["Q", 54, 30.5, 64, 23.5],
            ["Q", 74, 16.5, 78, 13.5],
            ["Q", 82, 10.5, 84, 9.5],
            ["Q", 86, 8.5, 89.5, 6],
            ["Q", 93, 3.5, 94.5, 2],
            ["Q", 96, 0.5, 97.5, 0],
            ["Q", 99, -0.5, 99, 1],
            ["Q", 99, 2.5, 97.5, 6],
            ["Q", 96, 9.5, 92, 15],
            ["Q", 88, 20.5, 82.5, 28.5],
            ["Q", 77, 36.5, 71, 47],
            ["Q", 65, 57.5, 58, 71.5],
            ["Q", 51, 85.5, 46.5, 95],
            ["Q", 42, 104.5, 36, 115],
            ["Q", 30, 125.5, 27.5, 131],
            ["Q", 25, 136.5, 24, 138.5],
            ["Q", 23, 140.5, 21.5, 144.5],
            ["Q", 20, 148.5, 19, 149.5],
            ["Q", 18, 150.5, 18, 152],
            ["Q", 18, 153.5, 18, 154.5],
            ["Q", 18, 155.5, 19, 155.5],
            ["Q", 20, 155.5, 21.5, 154],
            ["Q", 23, 152.5, 27, 149],
            ["Q", 31, 145.5, 41.5, 136.5],
            ["Q", 52, 127.5, 61.5, 118],
            ["Q", 71, 108.5, 82.5, 95.5],
            ["Q", 94, 82.5, 105.5, 69.5],
            ["Q", 117, 56.5, 122.5, 51],
            ["Q", 128, 45.5, 133, 39],
            ["Q", 138, 32.5, 142.5, 26.5],
            ["Q", 147, 20.5, 149.5, 18],
            ["Q", 152, 15.5, 154.5, 13],
            ["Q", 157, 10.5, 158, 10],
            ["Q", 159, 9.5, 158, 9.5],
            ["Q", 157, 9.5, 152, 14],
            ["Q", 147, 18.5, 139.5, 26.5],
            ["Q", 132, 34.5, 122.5, 46.5],
            ["Q", 113, 58.5, 98, 79.5],
            ["Q", 83, 100.5, 70, 122],
            ["Q", 57, 143.5, 48.5, 163],
            ["Q", 40, 182.5, 30, 207],
            ["Q", 20, 231.5, 18, 241],
            ["Q", 16, 250.5, 14.5, 255],
            ["Q", 13, 259.5, 10.5, 268],
            ["Q", 8, 276.5, 7.5, 280.5],
            ["Q", 7, 284.5, 6.5, 286.5],
            ["Q", 6, 288.5, 7, 284],
            ["Q", 8, 279.5, 11.5, 272],
            ["Q", 15, 264.5, 23, 252],
            ["Q", 31, 239.5, 43, 224.5],
            ["Q", 55, 209.5, 74.5, 187],
            ["Q", 94, 164.5, 114, 141.5],
            ["Q", 134, 118.5, 142, 109],
            ["Q", 150, 99.5, 164, 85],
            ["Q", 178, 70.5, 184, 63.5],
            ["Q", 190, 56.5, 196, 50],
            ["Q", 202, 43.5, 206, 39.5],
            ["Q", 210, 35.5, 212, 32.5],
            ["Q", 214, 29.5, 215.5, 28.5],
            ["Q", 217, 27.5, 218.5, 26],
            ["Q", 220, 24.5, 218.5, 26],
            ["Q", 217, 27.5, 211.5, 33.5],
            ["Q", 206, 39.5, 197, 53.5],
            ["Q", 188, 67.5, 182.5, 76.5],
            ["Q", 177, 85.5, 171, 98.5],
            ["Q", 165, 111.5, 158.5, 125],
            ["Q", 152, 138.5, 150.5, 142.5],
            ["Q", 149, 146.5, 146, 153],
            ["Q", 143, 159.5, 141.5, 163.5],
            ["Q", 140, 167.5, 139.5, 169],
            ["Q", 139, 170.5, 139, 171],
            ["Q", 139, 171.5, 139, 172.5],
            ["Q", 139, 173.5, 139, 172.5],
            ["Q", 139, 171.5, 139.5, 171],
            ["Q", 140, 170.5, 141.5, 169.5],
            ["Q", 143, 168.5, 147, 167],
            ["Q", 151, 165.5, 158, 161],
            ["Q", 165, 156.5, 175.5, 148],
            ["Q", 186, 139.5, 191.5, 134],
            ["Q", 197, 128.5, 200, 125.5],
            ["Q", 203, 122.5, 208, 119],
            ["Q", 213, 115.5, 215, 113],
            ["Q", 217, 110.5, 219.5, 110],
            ["Q", 222, 109.5, 222, 110],
            ["Q", 222, 110.5, 216, 122],
            ["Q", 210, 133.5, 201, 149],
            ["Q", 192, 164.5, 187, 174],
            ["Q", 182, 183.5, 176, 196],
            ["Q", 170, 208.5, 163.5, 221.5],
            ["Q", 157, 234.5, 153, 242],
            ["Q", 149, 249.5, 147, 253.5],
            ["Q", 145, 257.5, 144.5, 261.5],
            ["Q", 144, 265.5, 143.5, 267.5],
            ["Q", 143, 269.5, 145, 269.5],
            ["Q", 147, 269.5, 152, 266.5],
            ["Q", 157, 263.5, 165, 256],
            ["Q", 173, 248.5, 182, 239.5],
            ["Q", 191, 230.5, 201.5, 219],
            ["Q", 212, 207.5, 223, 195.5],
            ["Q", 234, 183.5, 238.5, 179],
            ["Q", 243, 174.5, 245, 171.5],
            ["Q", 247, 168.5, 250.5, 165],
            ["Q", 254, 161.5, 256, 160],
            ["Q", 258, 158.5, 259, 157.5],
            ["Q", 260, 156.5, 260.5, 156.5],
            ["Q", 261, 156.5, 259.5, 159.5],
            ["Q", 258, 162.5, 254.5, 169],
            ["Q", 251, 175.5, 245, 184.5],
            ["Q", 239, 193.5, 236, 198],
            ["Q", 233, 202.5, 227.5, 211],
            ["Q", 222, 219.5, 218.5, 224.5],
            ["Q", 215, 229.5, 212, 235.5],
            ["Q", 209, 241.5, 207, 246],
            ["Q", 205, 250.5, 204, 253],
            ["Q", 203, 255.5, 202, 258],
            ["Q", 201, 260.5, 200.5, 262],
            ["Q", 200, 263.5, 200, 264.5],
            ["Q", 200, 265.5, 200, 266],
            ["Q", 200, 266.5, 200, 267.5],
            ["Q", 200, 268.5, 200, 267.5],
            ["Q", 200, 266.5, 200.5, 266],
            ["Q", 201, 265.5, 202, 264.5],
            ["Q", 203, 263.5, 204, 263],
            ["Q", 205, 262.5, 207.5, 261],
            ["Q", 210, 259.5, 213, 258],
            ["Q", 216, 256.5, 217.5, 256],
            ["Q", 219, 255.5, 220.5, 254.5],
            ["Q", 222, 253.5, 222.5, 253],
            ["Q", 223, 252.5, 224, 252],
            ["Q", 225, 251.5, 225, 251],
            ["Q", 225, 250.5, 225.5, 250.5],
            ["Q", 226, 250.5, 227, 250.5],
            ["Q", 228, 250.5, 228.5, 249.5],
            ["Q", 229, 248.5, 230, 248],
            ["Q", 231, 247.5, 232.5, 246.5],
            ["Q", 234, 245.5, 234.5, 245.5],
            ["Q", 235, 245.5, 236.5, 244.5],
            ["Q", 238, 243.5, 239, 243],
            ["Q", 240, 242.5, 240.5, 242],
            ["Q", 241, 241.5, 242, 241],
            ["Q", 243, 240.5, 244, 240],
            ["Q", 245, 239.5, 245.5, 239],
            ["Q", 246, 238.5, 247, 237.5],
            ["Q", 248, 236.5, 248.5, 236.5],
            ["Q", 249, 236.5, 249, 236],
            ["Q", 249, 235.5, 249, 237],
            ["Q", 249, 238.5, 249, 240.5],
            ["Q", 249, 242.5, 248, 245],
            ["Q", 247, 247.5, 247, 249.5],
            ["Q", 247, 251.5, 246, 253.5],
            ["Q", 245, 255.5, 245, 257],
            ["Q", 245, 258.5, 245, 259.5],
            ["Q", 245, 260.5, 245, 261.5],
            ["L", 245, 262.5]
        ],
        "pathOffset": {
            "x": 0,
            "y": 0
        }
    }, {
        "type": "path",
        "originX": "center",
        "originY": "center",
        "left": 1031.5,
        "top": 498.5,
        "width": 244,
        "height": 181,
        "fill": null,
        "stroke": "rgb(0, 0, 0)",
        "strokeWidth": 3,
        "strokeLineCap": "round",
        "strokeLineJoin": "round",
        "strokeMiterLimit": 10,
        "scaleX": 1,
        "scaleY": 1,
        "angle": 0,
        "flipX": false,
        "flipY": false,
        "opacity": 1,
        "shadow": null,
        "visible": true,
        "clipTo": null,
        "backgroundColor": "",
        "path": [
            ["M", 243.5, 0],
            ["Q", 243.5, 0, 244, 0],
            ["Q", 244.5, 0, 243.75, 0],
            ["Q", 243, 0, 239, 0],
            ["Q", 235, 0, 226.5, 0],
            ["Q", 218, 0, 191, 2.5],
            ["Q", 164, 5, 134, 7.5],
            ["Q", 104, 10, 87, 11.5],
            ["Q", 70, 13, 59.5, 14.5],
            ["Q", 49, 16, 43.5, 16.5],
            ["Q", 38, 17, 28.5, 18],
            ["Q", 19, 19, 14, 20],
            ["Q", 9, 21, 6.5, 21.5],
            ["Q", 4, 22, 3.5, 22],
            ["Q", 3, 22, 2, 22.5],
            ["Q", 1, 23, 1, 24],
            ["Q", 1, 25, 1, 25.5],
            ["Q", 1, 26, 1, 30],
            ["Q", 1, 34, 1, 40],
            ["Q", 1, 46, 1, 56.5],
            ["Q", 1, 67, 1, 80.5],
            ["Q", 1, 94, 1, 106.5],
            ["Q", 1, 119, 1, 124.5],
            ["Q", 1, 130, 1, 136.5],
            ["Q", 1, 143, 1, 149.5],
            ["Q", 1, 156, 1, 160],
            ["Q", 1, 164, 0.5, 165.5],
            ["Q", 0, 167, 0, 168],
            ["Q", 0, 169, 0, 169.5],
            ["Q", 0, 170, 0, 171],
            ["Q", 0, 172, 0, 172.5],
            ["Q", 0, 173, 0, 174],
            ["Q", 0, 175, 0, 175.5],
            ["Q", 0, 176, 0, 177],
            ["Q", 0, 178, 0, 178.5],
            ["Q", 0, 179, 0, 180],
            ["L", 0, 181]
        ],
        "pathOffset": {
            "x": 0,
            "y": 0
        }
    }, {
        "type": "path",
        "originX": "center",
        "originY": "center",
        "left": 585.25,
        "top": 293.5,
        "width": 1168,
        "height": 581,
        "fill": null,
        "stroke": "rgb(0, 0, 0)",
        "strokeWidth": 3,
        "strokeLineCap": "round",
        "strokeLineJoin": "round",
        "strokeMiterLimit": 10,
        "scaleX": 1,
        "scaleY": 1,
        "angle": 0,
        "flipX": false,
        "flipY": false,
        "opacity": 1,
        "shadow": null,
        "visible": true,
        "clipTo": null,
        "backgroundColor": "",
        "path": [
            ["M", 0, 581],
            ["Q", 0, 581, 0.5, 581],
            ["Q", 1, 581, 1.75, 581],
            ["Q", 2.5, 581, 6, 580.5],
            ["Q", 9.5, 580, 18, 576],
            ["Q", 26.5, 572, 50, 561],
            ["Q", 73.5, 550, 98.5, 536],
            ["Q", 123.5, 522, 154.5, 504.5],
            ["Q", 185.5, 487, 217, 468.5],
            ["Q", 248.5, 450, 279.5, 434],
            ["Q", 310.5, 418, 330, 406.5],
            ["Q", 349.5, 395, 392.5, 371.5],
            ["Q", 435.5, 348, 458.5, 334.5],
            ["Q", 481.5, 321, 505, 307.5],
            ["Q", 528.5, 294, 545.5, 286],
            ["Q", 562.5, 278, 571.5, 273.5],
            ["Q", 580.5, 269, 600.5, 258],
            ["Q", 620.5, 247, 633.5, 239.5],
            ["Q", 646.5, 232, 654.5, 227.5],
            ["Q", 662.5, 223, 671.5, 217.5],
            ["Q", 680.5, 212, 683.5, 210],
            ["Q", 686.5, 208, 691.5, 205.5],
            ["Q", 696.5, 203, 697, 200.5],
            ["Q", 697.5, 198, 698.5, 198],
            ["Q", 699.5, 198, 704.5, 197.5],
            ["Q", 709.5, 197, 715, 195],
            ["Q", 720.5, 193, 728, 191],
            ["Q", 735.5, 189, 748, 184],
            ["Q", 760.5, 179, 770.5, 175.5],
            ["Q", 780.5, 172, 794, 167.5],
            ["Q", 807.5, 163, 823, 158.5],
            ["Q", 838.5, 154, 851, 150.5],
            ["Q", 863.5, 147, 868.5, 145.5],
            ["Q", 873.5, 144, 884, 141],
            ["Q", 894.5, 138, 900.5, 135],
            ["Q", 906.5, 132, 911, 130.5],
            ["Q", 915.5, 129, 919.5, 127],
            ["Q", 923.5, 125, 928, 123],
            ["Q", 932.5, 121, 939, 117],
            ["Q", 945.5, 113, 948.5, 111.5],
            ["Q", 951.5, 110, 955, 108],
            ["Q", 958.5, 106, 961.5, 103.5],
            ["Q", 964.5, 101, 967.5, 99.5],
            ["Q", 970.5, 98, 973.5, 96.5],
            ["Q", 976.5, 95, 980, 93],
            ["Q", 983.5, 91, 986.5, 89.5],
            ["Q", 989.5, 88, 992.5, 87],
            ["Q", 995.5, 86, 999.5, 83.5],
            ["Q", 1003.5, 81, 1006.5, 79.5],
            ["Q", 1009.5, 78, 1013, 76.5],
            ["Q", 1016.5, 75, 1019.5, 73.5],
            ["Q", 1022.5, 72, 1024.5, 70.5],
            ["Q", 1026.5, 69, 1029.5, 67.5],
            ["Q", 1032.5, 66, 1035.5, 63.5],
            ["Q", 1038.5, 61, 1041, 59.5],
            ["Q", 1043.5, 58, 1046.5, 56.5],
            ["Q", 1049.5, 55, 1052.5, 53.5],
            ["Q", 1055.5, 52, 1058, 51],
            ["Q", 1060.5, 50, 1062.5, 48.5],
            ["Q", 1064.5, 47, 1066, 46.5],
            ["Q", 1067.5, 46, 1070.5, 44.5],
            ["Q", 1073.5, 43, 1075.5, 42],
            ["Q", 1077.5, 41, 1079, 40],
            ["Q", 1080.5, 39, 1082, 38],
            ["Q", 1083.5, 37, 1086, 36],
            ["Q", 1088.5, 35, 1091, 34],
            ["Q", 1093.5, 33, 1096.5, 32.5],
            ["Q", 1099.5, 32, 1102, 31],
            ["Q", 1104.5, 30, 1107.5, 29.5],
            ["Q", 1110.5, 29, 1113, 28],
            ["Q", 1115.5, 27, 1117, 26.5],
            ["Q", 1118.5, 26, 1120, 26],
            ["Q", 1121.5, 26, 1122.5, 25],
            ["Q", 1123.5, 24, 1126, 23.5],
            ["Q", 1128.5, 23, 1130, 22],
            ["Q", 1131.5, 21, 1133.5, 20.5],
            ["Q", 1135.5, 20, 1136.5, 20],
            ["Q", 1137.5, 20, 1139, 19],
            ["Q", 1140.5, 18, 1142, 18],
            ["Q", 1143.5, 18, 1144, 18],
            ["Q", 1144.5, 18, 1145.5, 17.5],
            ["Q", 1146.5, 17, 1147, 17],
            ["Q", 1147.5, 17, 1147.5, 16],
            ["Q", 1147.5, 15, 1148.5, 15],
            ["Q", 1149.5, 15, 1149.5, 14.5],
            ["Q", 1149.5, 14, 1150, 13],
            ["Q", 1150.5, 12, 1151.5, 11.5],
            ["Q", 1152.5, 11, 1153, 10],
            ["Q", 1153.5, 9, 1154.5, 8.5],
            ["Q", 1155.5, 8, 1155.5, 7.5],
            ["Q", 1155.5, 7, 1156.5, 6.5],
            ["Q", 1157.5, 6, 1157.5, 5],
            ["Q", 1157.5, 4, 1158.5, 4],
            ["Q", 1159.5, 4, 1159.5, 3.5],
            ["Q", 1159.5, 3, 1160, 2],
            ["Q", 1160.5, 1, 1161.5, 1],
            ["Q", 1162.5, 1, 1163, 0.5],
            ["Q", 1163.5, 0, 1164.5, 0],
            ["Q", 1165.5, 0, 1166, 0],
            ["Q", 1166.5, 0, 1167.5, 0],
            ["L", 1168.5, 0]
        ],
        "pathOffset": {
            "x": 0,
            "y": 0
        }
    }],
    "background": "",
    "width": 1156,
    "height": 588,
    "eas": "0.0.1",
    "fabric": "1.4.7",
    "canvas": "0.0.1"
};

var scale = (width / json.width) / 2;
//json = eas.util.updateFabricObjects(json);
canvas.loadFromJSON(updateFabricObjects(json), function(scale) {
    this.forEachObject(function(obj) {
        if (typeof obj !== 'undefined') {
            obj.left *= scale;
            obj.top *= scale;
            obj.scaleX *= scale;
            obj.scaleY *= scale;
            obj.setCoords(); // スケールの変更を反映させる
        }
    }.bind(canvas));
    this.calcOffset();

    var setBackgroundImageCallback = function() {
        this.trigger('eas:before:render');
        this.renderAll();
        this.trigger('eas:after:render');
    }.bind(canvas);

    if (json.backgroundImage) {
        this.setBackgroundImage(json.backgroundImage.src, setBackgroundImageCallback, {
            opacity: 1,
            scaleX: 1,
            scaleY: 1,
            originX: 'left',
            originY: 'top'
        });
    } else {
        setBackgroundImageCallback();
    }
}.bind(canvas, scale));

//console.log(canvas.toDataURL());

var out = fs.createWriteStream(__dirname + '/../tmp/out.png');
var stream = canvas.createPNGStream();
stream.on('data', function(chunk) {
    out.write(chunk);
});

function updateFabricObjects(json) {
    if (_.isNull(json) || _.isUndefined(json)) {
        return json;
    }

    if (_.isNull(json.fabric) || _.isUndefined(json.fabric)) {
        return json;
    }

    // 1.4.11 -> 1.4.12で手書き(Path)オブジェクトがの座標計算が変更されていたため、
    // v1.4系で作成されたpathオブジェクトを1.6相当に変換する
    if (json.fabric.match(/1.4\..*/i) !== null) {
        json.objects.forEach(function(obj) {
            if (obj.type === "path") {
                obj.pathOffset = {
                    x: (obj.minX || 0) + (obj.width / 2),
                    y: (obj.minY || 0) + (obj.height / 2)
                };
            }
        })
    }
    return json
}
